---
phase: 02-match-lifecycle-breach-outcomes
plan: '02'
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - apps/server/src/server.ts
  - apps/server/src/lobby-session.ts
  - apps/server/AGENTS.md
  - tests/integration/server/match-lifecycle.test.ts
autonomous: true
requirements:
  - MATCH-01
  - MATCH-02
  - MATCH-03
must_haves:
  truths:
    - Host can start only under locked preconditions, and room status follows `lobby -> countdown -> active -> finished`.
    - Canonical breach completion transitions immediately to `finished` with explicit winner/defeated outcomes.
    - Defeated users are blocked from gameplay mutations with explicit `reason: defeated` responses.
    - Active disconnect expiry never creates a non-breach terminal outcome; breach remains the only terminal path.
  artifacts:
    - path: apps/server/src/server.ts
      provides: Authoritative room lifecycle runtime, mutation gates, and finished/restart state handling.
    - path: apps/server/src/lobby-session.ts
      provides: Reconnect-hold data access for lifecycle precondition checks during start/restart.
    - path: tests/integration/server/match-lifecycle.test.ts
      provides: Integration contract coverage for countdown/cancel/finish/restart/defeat lockout behavior.
    - path: apps/server/AGENTS.md
      provides: Updated event contract documenting new lifecycle/results/restart semantics.
  key_links:
    - from: apps/server/src/server.ts
      to: packages/rts-engine/match-lifecycle.ts
      via: Socket handlers delegate transition legality and ranking to engine helpers.
      pattern: canStart|canRestart|resolveMatchOutcome
    - from: apps/server/src/server.ts
      to: tests/integration/server/match-lifecycle.test.ts
      via: Integration suite asserts emitted lifecycle/results payload contracts.
      pattern: room:countdown|room:match-started|room:match-finished|room:error
---

<objective>
Wire server runtime to enforce one authoritative lifecycle and breach-finish path, including defeat lockouts and deterministic restart behavior.

Purpose: Deliver MATCH-01/02/03 at the Socket.IO authority boundary with explicit rejection reasons and no lifecycle drift.
Output: Updated server lifecycle handlers, new integration contract suite, and aligned server event documentation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-match-lifecycle-breach-outcomes/02-CONTEXT.md
@.planning/phases/02-match-lifecycle-breach-outcomes/02-RESEARCH.md
@.planning/phases/01-lobby-team-reliability/01-02-SUMMARY.md
@.planning/phases/01-lobby-team-reliability/01-03-SUMMARY.md
@apps/server/src/server.ts
@apps/server/src/lobby-session.ts
@tests/integration/server/lobby-contract.test.ts
</context>

<tasks>

<task type="auto">
  <name>task 1: add failing integration coverage for lifecycle, finish authority, and restart semantics</name>
  <files>tests/integration/server/match-lifecycle.test.ts</files>
  <action>Create RED integration tests that cover: host-only start, start/restart preconditions (exactly one player per team slot, both connected, no reconnect hold pending), 3-second countdown, host countdown cancel before zero, disconnect during countdown not canceling countdown, authoritative transition to `finished` on breach with ordered results payload, host-only restart with explicit rejection reason when invalid, full restart reset (map, structures/HP, queue, economy, defeat flags, prior results), and persistent chat availability in `countdown`, `active`, `finished`, and defeated read-only sessions.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/match-lifecycle.test.ts</automated>
    <manual>Confirm RED tests fail before server lifecycle changes are applied.</manual>
  </verify>
  <done>Integration contract captures all locked lifecycle/outcome semantics that are currently missing in runtime behavior.</done>
</task>

<task type="auto">
  <name>task 2: implement authoritative lifecycle transitions, finish freeze, and restart flow</name>
  <files>apps/server/src/server.ts, apps/server/src/lobby-session.ts</files>
  <action>Update runtime room model to include `finished` status and authoritative final-results snapshot wiring from engine outcomes. Enforce start/restart guards from locked decisions (exact slot occupancy, both players connected, no pending hold), keep countdown duration at 3 seconds, allow host cancel during countdown, and keep countdown running through disconnects. On breach resolution, transition immediately to `finished`, freeze gameplay mutations, and emit explicit winner/defeated standings + post-match stats. Implement host-only restart from `finished` that preserves team slot assignments while fully resetting map/structures/HP/queues/economy/defeat/results state. During `active`, keep simulation running on disconnect and ensure hold expiry does not remove teams or create disconnect-timeout terminal losses.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/match-lifecycle.test.ts</automated>
  </verify>
  <done>Server lifecycle is canonical and deterministic, with breach-only terminal behavior and authoritative restart handling.</done>
</task>

<task type="auto">
  <name>task 3: enforce defeat mutation lockouts and align runtime contract docs</name>
  <files>apps/server/src/server.ts, apps/server/AGENTS.md</files>
  <action>Add one centralized gameplay-mutation gate used by `build:queue`, `cell:update`, and future mutation events: reject non-active states with explicit reason, reject defeated sessions with `reason: defeated`, and keep chat pathways enabled for countdown/active/finished/read-only users. Update server AGENTS event contract with new lifecycle/results/restart events and reason codes using multi-team-safe wording (`winner`, `defeated`/`eliminated`, avoid binary loser assumptions).</action>
  <verify>
    <automated>npx vitest run tests/integration/server/match-lifecycle.test.ts tests/integration/server/lobby-contract.test.ts tests/integration/server/lobby-reconnect.test.ts</automated>
  </verify>
  <done>Mutation lockouts are server-authoritative, explicit reason codes are stable, and lifecycle documentation matches emitted contract.</done>
</task>

</tasks>

<verification>
Run the task 3 command and confirm both new lifecycle integration checks and prior lobby/reconnect suites pass without contract regressions.
</verification>

<success_criteria>

- Runtime emits legal transitions only and reaches `finished` only through canonical breach resolution.
- Defeated users cannot mutate gameplay and always receive explicit `defeated` rejection reason.
- Restart is deterministic, host-only, and fully resets match internals while preserving slot assignments.
- Disconnect behavior during active play cannot terminate matches outside breach logic.
  </success_criteria>

<output>
After completion, create `.planning/phases/02-match-lifecycle-breach-outcomes/02-02-SUMMARY.md`
</output>
