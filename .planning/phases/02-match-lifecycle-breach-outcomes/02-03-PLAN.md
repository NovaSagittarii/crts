---
phase: 02-match-lifecycle-breach-outcomes
plan: '03'
type: execute
wave: 3
depends_on:
  - 02-02
files_modified:
  - apps/web/index.html
  - apps/web/src/client.ts
  - apps/web/AGENTS.md
autonomous: true
requirements:
  - MATCH-01
  - MATCH-02
  - MATCH-03
must_haves:
  truths:
    - Users always see clear lifecycle state (countdown, active, finished) with explicit in-match and post-match messaging.
    - Defeated users are persistently in read-only spectating mode while board/HUD/chat remain live.
    - Finished state shows ranked winner/defeated outcomes with required per-team stats and host-gated restart controls.
    - Users who locally switch back to lobby view in `finished` can still be pulled into restarted countdown if still valid room members.
  artifacts:
    - path: apps/web/index.html
      provides: Lifecycle overlays and results-panel layout elements for countdown/finished/defeat states.
    - path: apps/web/src/client.ts
      provides: Client state wiring for defeat lockout, results rendering, restart controls, and spectating UX.
    - path: apps/web/AGENTS.md
      provides: Updated client event usage for finished/restart/results lifecycle flows.
  key_links:
    - from: apps/web/src/client.ts
      to: apps/server/src/server.ts
      via: Socket listeners/emits for `room:membership`, `room:match-finished`, `room:restart`, and `room:error` defeated handling.
      pattern: socket\.on|socket\.emit
    - from: apps/web/src/client.ts
      to: apps/web/index.html
      via: Countdown/defeat/results overlays and minimized panel action wiring.
      pattern: getRequiredElement|classList|textContent
---

<objective>
Ship the user-facing lifecycle and defeat experience so players get explicit countdown, defeat, and finished-state outcomes with correct restart control behavior.

Purpose: Fulfill MATCH-03 UX guarantees while reflecting MATCH-01/02 lifecycle and results contracts from server authority.
Output: Updated web UI/state handling for countdown overlays, persistent defeat read-only mode, and minimized finished-results panel interactions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-match-lifecycle-breach-outcomes/02-CONTEXT.md
@.planning/phases/02-match-lifecycle-breach-outcomes/02-RESEARCH.md
@apps/web/index.html
@apps/web/src/client.ts
@apps/server/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>task 1: implement countdown and finished overlays with host-gated restart controls</name>
  <files>apps/web/index.html, apps/web/src/client.ts</files>
  <action>Add a prominent center countdown overlay plus lifecycle status line, and a centered finished-results panel that is minimizable while keeping key action buttons pinned and visible. Implement host-only restart control with disabled waiting-for-host messaging for non-host users. Add a local return-to-lobby view toggle for `finished` that does not emit `room:leave`, so valid room members still get pulled into restarted countdown when host restarts.</action>
  <verify>
    <automated>npm run build</automated>
    <manual>Open the app and verify countdown overlay, minimizable finished panel, and host vs non-host restart states on desktop/mobile widths.</manual>
  </verify>
  <done>Lifecycle overlays and restart controls match locked semantics, including immediate finished->countdown replacement when restart begins.</done>
</task>

<task type="auto">
  <name>task 2: enforce persistent defeat read-only spectating UX</name>
  <files>apps/web/src/client.ts, apps/web/index.html</files>
  <action>When current player/team outcome is defeated or room status is non-active, hard-disable gameplay mutation controls and canvas edit paths while preserving board rendering and HUD updates. Show persistent defeat banner/overlay with explicit reason text and spectating wording. Surface server `room:error` `reason: defeated` as persistent user-visible feedback. Keep chat available in `countdown`, `active`, `finished`, and defeated read-only states; keep disconnect indicators visible from membership payloads during active play.</action>
  <verify>
    <automated>npm run build</automated>
  </verify>
  <done>Defeated users cannot perform gameplay mutations client-side and clearly remain in read-only spectating mode with live visibility.</done>
</task>

<task type="auto">
  <name>task 3: render ranked post-match stats contract and run phase gate</name>
  <files>apps/web/src/client.ts, apps/web/AGENTS.md</files>
  <action>Render winner-first ranked standings using multi-team-safe copy (`winner`, `defeated`/`eliminated`) and include required per-team stats: final core HP/state, territory/cell count, and queued/applied/rejected build counts. Show absolute values plus compact comparative indicators. Track timeline metadata if provided but do not implement timeline event display UI or zoom controls in this phase. Update web AGENTS event usage docs for finished/results/restart client handling and run final build+integration validation.</action>
  <verify>
    <automated>npm run build && npx vitest run tests/integration/server/match-lifecycle.test.ts</automated>
  </verify>
  <done>Finished-state UI reflects authoritative ranked outcomes and stats while preserving deferred-scope boundaries.</done>
</task>

</tasks>

<verification>
Run task 3 command and perform a manual pass through start -> countdown -> active -> breach -> finished -> restart to confirm lockout and panel behaviors.
</verification>

<success_criteria>

- Countdown and finished transitions are visually explicit and synchronized with server lifecycle state.
- Defeat UX is persistent, clear, and read-only while chat/visibility remain available.
- Finished panel can be minimized, host restart is authoritative, and non-host users see clear waiting messaging.
- Results rendering uses ranked multi-team-safe language and required stats without adding deferred timeline/zoom UI.
  </success_criteria>

<output>
After completion, create `.planning/phases/02-match-lifecycle-breach-outcomes/02-03-SUMMARY.md`
</output>
