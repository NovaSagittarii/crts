---
phase: 01-lobby-team-reliability
plan: '04'
type: execute
wave: 4
depends_on:
  - 01-03
files_modified:
  - apps/web/index.html
  - apps/web/src/client.ts
  - apps/web/AGENTS.md
autonomous: true
requirements:
  - LOBBY-01
  - LOBBY-02
  - LOBBY-03
  - LOBBY-04
must_haves:
  truths:
    - User can browse rooms, join by room code, and understand player/spectator occupancy.
    - User sees team identity (color + label), ready state, host marker, and quiet disconnect indicator.
    - User sees lobby spawn markers before match start and updated markers on rematch reseed.
    - Reconnect and slot-claim race outcomes are visible through inline status and toast messaging.
  artifacts:
    - path: apps/web/index.html
      provides: Lobby controls and status UI for room/team/reconnect behavior.
    - path: apps/web/src/client.ts
      provides: Client event wiring, session persistence, lobby rendering, and interaction handlers.
    - path: apps/web/AGENTS.md
      provides: Updated documented client event usage for added lobby/reconnect/chat events.
  key_links:
    - from: apps/web/src/client.ts
      to: apps/server/src/server.ts
      via: Socket event emit/listen pairs for room lifecycle, ready/start, claim-slot, reconnect status, and chat.
      pattern: socket\.emit|socket\.on
    - from: apps/web/src/client.ts
      to: browser localStorage
      via: Persisted `sessionId` used in Socket.IO auth payload for reconnect continuity.
      pattern: localStorage|auth
---

<objective>
Upgrade the browser lobby UX to reflect authoritative team/spectator/reconnect state so users can reliably understand and control pre-match flow.

Purpose: Surface locked decision behavior in the client while preserving server authority.
Output: Updated lobby UI/controls, reconnect-aware client identity handling, and event-contract-aligned client behavior.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-lobby-team-reliability/01-CONTEXT.md
@.planning/phases/01-lobby-team-reliability/01-RESEARCH.md
@apps/web/index.html
@apps/web/src/client.ts
</context>

<tasks>

<task type="auto">
  <name>task 1: implement lobby roster and status rendering for players, spectators, and countdown</name>
  <files>apps/web/index.html, apps/web/src/client.ts</files>
  <action>Add UI sections for room-code join, player slots, spectator list, ready badges/icons, host marker, team color + explicit team labels, and quiet disconnected iconography. Render lobby spawn markers from authoritative payload before match start, and refresh markers when rematch reseeds spawn orientation.</action>
  <verify>
    <automated>npm run build</automated>
    <manual>Open local app and confirm roster/countdown/spawn marker blocks render on desktop and mobile widths.</manual>
  </verify>
  <done>Lobby visuals represent authoritative occupancy/readiness/disconnect/spawn status without client-side simulation shortcuts.</done>
</task>

<task type="auto">
  <name>task 2: wire lobby interactions for join-by-slot, ready/start, and spectator chat</name>
  <files>apps/web/src/client.ts</files>
  <action>Implement emit/listen handlers for room-code join, explicit claim-by-slot, ready toggle, host start request, countdown state, race-failure reasons, and room chat messages available to both players and spectators. Keep no-team-switch policy reflected in controls and use inline status + toast text for reclaim/claim failures per locked decisions.</action>
  <verify>
    <automated>npm run build</automated>
  </verify>
  <done>All required lobby controls route through server events with user-visible feedback for success and failure paths.</done>
</task>

<task type="auto">
  <name>task 3: persist reconnect identity and fallback display naming on client bootstrap</name>
  <files>apps/web/src/client.ts, apps/web/AGENTS.md</files>
  <action>Persist a stable `sessionId` in local storage and send it via Socket.IO `auth` on connect/reconnect. If name input is blank at join time, use `guest-{uuid}` fallback behavior and preserve duplicate visible names while disambiguating via team labels in roster display. Update AGENTS client event usage so implementation and docs stay aligned.</action>
  <verify>
    <automated>npm run build && npx vitest run tests/integration/server/lobby-reconnect.test.ts</automated>
  </verify>
  <done>Reconnect identity continuity and fallback naming behavior are visible in client logic and aligned with server tests.</done>
</task>

</tasks>

<verification>
Run `npm run build` and spot-check in browser that countdown, ready badges, disconnect icon, spawn markers, and claim-slot controls all render and update from server events.
</verification>

<success_criteria>

- Client exposes all required lobby controls and statuses without violating server authority.
- Reconnect race outcomes are visible via inline and toast-style messages.
- Lobby UI remains responsive on desktop and mobile.
  </success_criteria>

<output>
After completion, create `.planning/phases/01-lobby-team-reliability/01-04-SUMMARY.md`
</output>
