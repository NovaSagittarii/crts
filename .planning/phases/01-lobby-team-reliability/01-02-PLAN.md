---
phase: 01-lobby-team-reliability
plan: "02"
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - apps/server/src/server.ts
  - apps/server/AGENTS.md
  - tests/integration/server/lobby-contract.test.ts
autonomous: true
requirements:
  - LOBBY-01
  - LOBBY-02
must_haves:
  truths:
    - User can list/create/join/leave rooms and all connected clients observe matching membership updates.
    - Users can join via room list or room code while room player capacity stays capped at two plus spectators.
    - Host starts countdown only when both player slots are ready and force-start is disallowed when preconditions fail.
    - Spectators can watch active board/HUD and use full room chat.
  artifacts:
    - path: apps/server/src/server.ts
      provides: Authoritative Socket.IO lobby lifecycle and room membership revision broadcasts.
    - path: tests/integration/server/lobby-contract.test.ts
      provides: Runtime contract coverage for room/team/spectator/start guardrail behaviors.
    - path: apps/server/AGENTS.md
      provides: Updated server event contract for new lobby and chat events.
  key_links:
    - from: apps/server/src/server.ts
      to: packages/rts-engine/src/lobby.ts
      via: Socket event handlers call lobby domain transitions before broadcast.
      pattern: socket\.on\('room:|socket\.on\('chat:
    - from: apps/server/src/server.ts
      to: io.to\(room:
      via: Membership revision snapshots emitted to room-scoped channels.
      pattern: io\.to\(roomChannel
---

<objective>
Implement server-authoritative room/team lifecycle behavior so lobby actions become deterministic and aligned with locked host/readiness/spectator decisions.

Purpose: Deliver LOBBY-01 and LOBBY-02 end-to-end at the runtime event boundary.
Output: Updated Socket.IO event contract, deterministic room snapshots, and integration tests for core lobby flow.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-lobby-team-reliability/01-CONTEXT.md
@.planning/phases/01-lobby-team-reliability/01-RESEARCH.md
@apps/server/src/server.ts
@apps/server/AGENTS.md
@tests/integration/server/server.test.ts
</context>

<tasks>

<task type="auto">
  <name>task 1: add failing integration tests for deterministic room and team contract</name>
  <files>tests/integration/server/lobby-contract.test.ts</files>
  <action>Create RED integration coverage for list/create/join/leave determinism, room-code join, 2-player-plus-spectators capacity, explicit full-team rejection reasons, no team switching after assignment, ready toggles, host transfer before match, and 3-second countdown start guardrails (including ignoring Not Ready toggles during countdown and allowing countdown continuation when a player disconnects).</action>
  <verify>
    <automated>npx vitest run tests/integration/server/lobby-contract.test.ts</automated>
    <manual>Confirm new tests fail on current runtime before implementing handlers.</manual>
  </verify>
  <done>Integration test file exists and exposes the missing lobby/team runtime contract gaps.</done>
</task>

<task type="auto">
  <name>task 2: implement server lobby lifecycle, start guardrails, and spectator chat</name>
  <files>apps/server/src/server.ts</files>
  <action>Refactor socket handlers to use authoritative lobby room snapshots with monotonically increasing membership revisions. Support room-list browsing and room-code join, explicit join-by-slot for spectators, manual ready toggles, host-only start requests, and countdown policy from locked decisions (3 seconds, no force-start when required players are Not Ready, ignore Not Ready flips during countdown, continue countdown if disconnect happens mid-countdown). Keep room capacity at two player slots plus spectators, enforce explicit reasoned rejections, keep no team switching after choice, and broadcast room-scoped chat to players and spectators.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/lobby-contract.test.ts</automated>
  </verify>
  <done>Core lobby/team contract tests pass with deterministic state updates and spectator-inclusive chat visibility.</done>
</task>

<task type="auto">
  <name>task 3: align runtime contract docs and run regression integration tests</name>
  <files>apps/server/AGENTS.md, tests/integration/server/server.test.ts</files>
  <action>Update server event contract documentation for any added lobby/chat events and adapt existing integration tests that depended on legacy auto-team join assumptions so they still validate externally observable behavior under the new room/team model.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/lobby-contract.test.ts tests/integration/server/server.test.ts</automated>
  </verify>
  <done>Server contract docs match implementation and both new + legacy integration suites pass together.</done>
</task>

</tasks>

<verification>
Run `npx vitest run tests/integration/server/lobby-contract.test.ts tests/integration/server/server.test.ts` and confirm deterministic room snapshots/revisions across multiple clients.
</verification>

<success_criteria>

- LOBBY-01 room operations are deterministic and observable by all clients.
- LOBBY-02 assignment/ready/host rules are server-authoritative with explicit error reasons.
- Spectators can observe and chat during active gameplay without being auto-promoted.
  </success_criteria>

<output>
After completion, create `.planning/phases/01-lobby-team-reliability/01-02-SUMMARY.md`
</output>
