---
phase: 01-lobby-team-reliability
plan: '03'
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - apps/server/src/lobby-session.ts
  - apps/server/src/server.ts
  - tests/integration/server/lobby-reconnect.test.ts
autonomous: true
requirements:
  - LOBBY-04
  - LOBBY-01
must_haves:
  truths:
    - Reconnecting user can reclaim their held slot within 30 seconds and sees authoritative room state after reconnect.
    - Held player slots stay locked during hold window and are removed when timeout expires.
    - Reconnecting player has priority over spectator claim races during hold window.
    - If multiple sessions reconnect for the same identity, newest session keeps control.
  artifacts:
    - path: apps/server/src/lobby-session.ts
      provides: Hold-window timers and session ownership/reclaim coordination.
    - path: apps/server/src/server.ts
      provides: Socket handshake identity mapping and reconnect-first room resync flow.
    - path: tests/integration/server/lobby-reconnect.test.ts
      provides: Integration verification for hold timeout and reclaim race outcomes.
  key_links:
    - from: apps/server/src/server.ts
      to: apps/server/src/lobby-session.ts
      via: connect/disconnect events drive hold scheduling and reclaim logic.
      pattern: disconnect|reconnect|session
    - from: apps/server/src/server.ts
      to: room snapshot emit
      via: Full authoritative state sent after successful reclaim.
      pattern: room:joined|state
---

<objective>
Deliver reconnect reliability with strict slot-hold semantics so temporary disconnects do not cause identity drift or spectator race bugs.

Purpose: Satisfy LOBBY-04 and close reconnect-related consistency gaps called out in research.
Output: Dedicated session-hold coordinator, reconnect-aware server flow, and integration race-condition tests.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-lobby-team-reliability/01-CONTEXT.md
@.planning/phases/01-lobby-team-reliability/01-RESEARCH.md
@apps/server/src/server.ts
@tests/integration/server/lobby-contract.test.ts
</context>

<tasks>

<task type="auto">
  <name>task 1: add failing reconnect integration tests for hold and race semantics</name>
  <files>tests/integration/server/lobby-reconnect.test.ts</files>
  <action>Create RED tests for locked reconnect behavior: 30-second hold reservation, locked slot visibility, timeout-driven removal, reclaim priority over spectator claim attempts, post-timeout fallback to spectator when prior slot is occupied, and newest-session-wins conflict resolution when the same user reconnects from multiple clients.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/lobby-reconnect.test.ts</automated>
    <manual>Confirm reconnect tests fail before reconnect implementation begins.</manual>
  </verify>
  <done>Reconnect reliability expectations are codified as failing integration tests.</done>
</task>

<task type="auto">
  <name>task 2: implement stable session hold/reclaim coordinator and authoritative resync</name>
  <files>apps/server/src/lobby-session.ts, apps/server/src/server.ts</files>
  <action>Create a dedicated session manager that tracks durable session identity (from `socket.handshake.auth.sessionId`), current socket binding, held-slot expiration, and reclaim ownership. On disconnect, mark slot held for 30 seconds and keep it locked. On reconnect, reclaim slot before processing spectator claims; after timeout, remove held player state and allow explicit spectator slot claims. Always emit full authoritative room snapshot after connect/reconnect, using recovery as optimization rather than sole correctness path.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/lobby-reconnect.test.ts</automated>
  </verify>
  <done>Reconnect tests pass and slot ownership remains consistent across disconnect/reconnect races.</done>
</task>

<task type="auto">
  <name>task 3: expose reconnect race outcomes via snapshot status and toast-friendly errors</name>
  <files>apps/server/src/server.ts</files>
  <action>Include inline reconnect status fields in room snapshots (for quiet disconnected indicators) and emit explicit reasoned errors for reclaim failures/races so the web client can show both inline status and toast text. Keep wording deterministic and machine-testable in integration assertions.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/lobby-contract.test.ts tests/integration/server/lobby-reconnect.test.ts</automated>
  </verify>
  <done>Reconnect race outcomes are observable through server payloads/events and covered by integration tests.</done>
</task>

</tasks>

<verification>
Run `npx vitest run tests/integration/server/lobby-contract.test.ts tests/integration/server/lobby-reconnect.test.ts` and confirm reconnect scenarios are deterministic across retries.
</verification>

<success_criteria>

- LOBBY-04 reconnect reclaim flow works within 30 seconds with authoritative resync.
- Slot holds are correctly locked and eventually cleaned up on timeout.
- Rejoin races and multi-session conflicts emit explicit, user-visible outcomes.
  </success_criteria>

<output>
After completion, create `.planning/phases/01-lobby-team-reliability/01-03-SUMMARY.md`
</output>
