---
phase: 01-lobby-team-reliability
plan: '01'
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/rts-engine/src/lobby.ts
  - packages/rts-engine/src/spawn.ts
  - packages/rts-engine/src/rts.ts
  - packages/rts-engine/test/lobby.test.ts
  - packages/rts-engine/test/spawn.test.ts
autonomous: true
requirements:
  - LOBBY-02
  - LOBBY-03
must_haves:
  truths:
    - User can only occupy one player slot/team at a time.
    - User gets explicit rejection when trying to claim a full team slot.
    - Team base spawn points are evenly distributed on a torus and do not overlap.
    - Rematch recalculates spawn orientation instead of reusing prior positions.
  artifacts:
    - path: packages/rts-engine/src/lobby.ts
      provides: Authoritative lobby slot/team/ready lifecycle model for pre-match.
    - path: packages/rts-engine/src/spawn.ts
      provides: Deterministic torus circle spawn generation and overlap validation.
    - path: packages/rts-engine/test/lobby.test.ts
      provides: Unit coverage for slot claim, ready, and host transfer invariants.
    - path: packages/rts-engine/test/spawn.test.ts
      provides: Unit coverage for equal-angle spawn fairness and rematch reorientation.
  key_links:
    - from: packages/rts-engine/src/lobby.ts
      to: packages/rts-engine/src/spawn.ts
      via: Spawn seed/orientation passed into lobby room initialization.
      pattern: create.*spawn|compute.*spawn
    - from: packages/rts-engine/src/lobby.ts
      to: packages/rts-engine/src/rts.ts
      via: Deterministic base assignment used when creating team runtime state.
      pattern: baseTopLeft|team.*slot
---

<objective>
Establish deterministic pre-match lobby domain primitives before runtime wiring so slot/team/ready behavior and spawn fairness are testable in isolation.

Purpose: Lock down LOBBY-02 and LOBBY-03 invariants in package-level deterministic logic.
Output: New lobby/spawn engine modules plus unit tests proving slot assignment and torus fairness behavior.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-lobby-team-reliability/01-CONTEXT.md
@.planning/phases/01-lobby-team-reliability/01-RESEARCH.md
@packages/rts-engine/src/rts.ts
</context>

<tasks>

<task type="auto">
  <name>task 1: add failing unit specs for lobby slot and torus spawn invariants</name>
  <files>packages/rts-engine/test/lobby.test.ts, packages/rts-engine/test/spawn.test.ts</files>
  <action>Create RED tests that encode locked decisions: 2-player capacity with spectators, explicit full-slot rejection reasons, no team switching after assignment, manual ready toggles, deterministic host transfer by join order, equal-angle torus spawn spacing, non-overlap, and rematch orientation re-randomization.</action>
  <verify>
    <automated>npx vitest run packages/rts-engine/test/lobby.test.ts packages/rts-engine/test/spawn.test.ts</automated>
    <manual>Confirm at least one assertion fails for each new scenario before implementation.</manual>
  </verify>
  <done>New tests exist and fail specifically for missing lobby/spawn behaviors.</done>
</task>

<task type="auto">
  <name>task 2: implement deterministic lobby room and spawn domain modules</name>
  <files>packages/rts-engine/src/lobby.ts, packages/rts-engine/src/spawn.ts</files>
  <action>Implement a server-agnostic lobby aggregate that tracks player slots, spectators, ready flags, host identity, countdown metadata, and explicit typed rejection reasons. Enforce one-player-one-team mapping, reject full-team claims with reason text, block team switching after claim, and support explicit spectator claim-by-slot actions. In `spawn.ts`, implement circle-on-torus spawn generation using equal angle steps and wrapped coordinate validation, with orientation seed input and rematch re-seeding support.</action>
  <verify>
    <automated>npx vitest run packages/rts-engine/test/lobby.test.ts packages/rts-engine/test/spawn.test.ts</automated>
  </verify>
  <done>All new lobby/spawn unit tests pass and expose deterministic APIs for runtime integration.</done>
</task>

<task type="auto">
  <name>task 3: wire lobby/spawn outputs into RTS room base assignment</name>
  <files>packages/rts-engine/src/rts.ts</files>
  <action>Replace candidate-based base assignment with deterministic spawn positions from the new spawn/lobby primitives so team base coordinates come from the same fairness model used by lobby previews. Preserve strict deterministic tick/build behavior and keep package runtime-agnostic.</action>
  <verify>
    <automated>npx vitest run packages/rts-engine/test/rts.test.ts packages/rts-engine/test/lobby.test.ts packages/rts-engine/test/spawn.test.ts</automated>
  </verify>
  <done>Runtime team base placement uses torus-circle spawn outputs and no longer falls back to ad hoc candidate selection.</done>
</task>

</tasks>

<verification>
Run `npx vitest run packages/rts-engine/test/lobby.test.ts packages/rts-engine/test/spawn.test.ts packages/rts-engine/test/rts.test.ts` and confirm deterministic pass without flaky ordering.
</verification>

<success_criteria>

- LOBBY-02 invariants are enforced in package logic with explicit rejection outcomes.
- LOBBY-03 fairness math is deterministic, equally spaced, and overlap-safe.
- Rematch spawn reseed behavior is codified and covered by tests.
  </success_criteria>

<output>
After completion, create `.planning/phases/01-lobby-team-reliability/01-01-SUMMARY.md`
</output>
