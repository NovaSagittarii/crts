---
phase: 01-lobby-team-reliability
plan: "05"
type: execute
wave: 4
depends_on:
  - 01-03
files_modified:
  - tests/integration/server/lobby-reliability.test.ts
  - packages/rts-engine/test/spawn.test.ts
  - packages/rts-engine/test/lobby.test.ts
autonomous: true
requirements:
  - LOBBY-01
  - LOBBY-02
  - LOBBY-03
  - LOBBY-04
must_haves:
  truths:
    - Full lobby reliability flow works across multiple sockets without state drift.
    - Team claim, ready/start, and spectator race policies stay deterministic under contention.
    - Torus spawn fairness and rematch reseed behavior remain regression-protected.
    - Reconnect reclaim behavior stays stable across future server changes.
  artifacts:
    - path: tests/integration/server/lobby-reliability.test.ts
      provides: End-to-end lobby reliability scenario coverage.
    - path: packages/rts-engine/test/lobby.test.ts
      provides: Regression assertions for deterministic lobby invariants.
    - path: packages/rts-engine/test/spawn.test.ts
      provides: Regression assertions for fair torus spawn geometry.
  key_links:
    - from: tests/integration/server/lobby-reliability.test.ts
      to: apps/server/src/server.ts
      via: Black-box socket interaction validates authoritative behavior.
      pattern: room:|state|chat:
    - from: packages/rts-engine/test/spawn.test.ts
      to: packages/rts-engine/src/spawn.ts
      via: Deterministic output assertions for spacing/wrapping/non-overlap.
      pattern: expect\(
---

<objective>
Lock the phase with deterministic regression coverage so lobby/team/reconnect behavior remains stable as subsequent phases modify match logic.

Purpose: Provide a single reliability safety net covering all Phase 1 requirement IDs.
Output: New integrated reliability suite plus strengthened unit regressions for lobby and spawn invariants.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-lobby-team-reliability/01-CONTEXT.md
@.planning/phases/01-lobby-team-reliability/01-RESEARCH.md
@tests/integration/server/server.test.ts
@tests/integration/server/lobby-contract.test.ts
@tests/integration/server/lobby-reconnect.test.ts
</context>

<tasks>

<task type="auto">
  <name>task 1: add end-to-end lobby reliability integration scenario</name>
  <files>tests/integration/server/lobby-reliability.test.ts</files>
  <action>Create a deterministic multi-client integration scenario that exercises room listing/creation/join/leave, explicit spectator slot claim, host transfer, ready/start countdown guardrails, spectator chat visibility, disconnect hold/reclaim, and timeout expiry fallback behavior. Assert authoritative membership revisions and room snapshots remain consistent between all connected clients.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/lobby-reliability.test.ts</automated>
  </verify>
  <done>Comprehensive lobby reliability integration test passes and reproduces no state divergence across clients.</done>
</task>

<task type="auto">
  <name>task 2: extend unit regressions for fairness and slot invariants</name>
  <files>packages/rts-engine/test/lobby.test.ts, packages/rts-engine/test/spawn.test.ts</files>
  <action>Add targeted regression cases for edge geometry (small/large torus dimensions), rematch reseed randomness bounds, and slot race edge cases so future changes cannot silently violate LOBBY-02/03/04 decisions.</action>
  <verify>
    <automated>npx vitest run packages/rts-engine/test/lobby.test.ts packages/rts-engine/test/spawn.test.ts</automated>
  </verify>
  <done>Unit regression tests cover known high-risk fairness and slot race edge conditions.</done>
</task>

<task type="auto">
  <name>task 3: run full relevant suites as phase reliability gate</name>
  <files>tests/integration/server/lobby-reliability.test.ts</files>
  <action>Execute a final gate run for all lobby-related unit and integration suites introduced in this phase and fix flaky timing assumptions if discovered (bounded retries, deterministic waits, complete teardown for all sockets and server instances).</action>
  <verify>
    <automated>npx vitest run packages/rts-engine/test/lobby.test.ts packages/rts-engine/test/spawn.test.ts tests/integration/server/lobby-contract.test.ts tests/integration/server/lobby-reconnect.test.ts tests/integration/server/lobby-reliability.test.ts</automated>
  </verify>
  <done>All phase-1 reliability tests pass together without flake and provide a reusable gate for later phases.</done>
</task>

</tasks>

<verification>
Run the full command from task 3 and confirm no intermittent failures across repeated runs.
</verification>

<success_criteria>

- Every Phase 1 requirement has direct automated regression coverage.
- Integration scenarios catch membership/reconnect drift and race regressions.
- Fair spawn and deterministic slot policies remain stable for future development.
  </success_criteria>

<output>
After completion, create `.planning/phases/01-lobby-team-reliability/01-05-SUMMARY.md`
</output>
