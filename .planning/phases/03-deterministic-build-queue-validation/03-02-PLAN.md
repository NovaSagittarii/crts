---
phase: 03-deterministic-build-queue-validation
plan: '02'
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - apps/server/src/server.ts
  - apps/server/AGENTS.md
  - tests/integration/server/server.test.ts
  - tests/integration/server/match-lifecycle.test.ts
autonomous: true
requirements:
  - BUILD-01
  - BUILD-02
  - BUILD-03
  - BUILD-04
must_haves:
  truths:
    - Queue requests receive immediate `build:queued` acknowledgement with `eventId` and `executeTick`.
    - Each acknowledged build eventually emits one terminal `build:outcome` (`applied` or `rejected(reason)`).
    - Runtime rejects direct gameplay bypass attempts (`cell:update`) with explicit reason instead of mutating grid.
    - Validation failures surface explicit reasons at the socket boundary (including bounds/territory cases).
  artifacts:
    - path: apps/server/src/server.ts
      provides: Authoritative queue-only mutation gate, queue ack handling, and room-scoped terminal-outcome emission.
    - path: tests/integration/server/server.test.ts
      provides: Integration assertions for queue ack/outcome contract and bypass rejection.
    - path: tests/integration/server/match-lifecycle.test.ts
      provides: Lifecycle contract coverage updated to avoid legacy direct-mutation assumptions.
    - path: apps/server/AGENTS.md
      provides: Server event/reason contract documentation including `build:outcome` and queue-only mutation rule.
  key_links:
    - from: apps/server/src/server.ts
      to: packages/rts-engine/rts.ts
      via: Runtime emits terminal outcomes from deterministic engine resolution outputs and pending-event drains.
      pattern: tickRoom|queueBuildEvent|build:queued|build:outcome
    - from: apps/server/src/server.ts
      to: tests/integration/server/server.test.ts
      via: Integration tests assert ack/outcome lifecycle and bypass rejection reasons.
      pattern: room:error|build:queued|build:outcome
---

<objective>
Wire the server/runtime contract so all gameplay mutations are queue-validated and every queued build has explicit observable outcomes.

Purpose: Deliver BUILD-01 through BUILD-04 at the Socket.IO boundary using the deterministic engine outputs from 03-01.
Output: Updated server handlers, integration contract coverage, and aligned runtime event documentation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-deterministic-build-queue-validation/03-RESEARCH.md
@.planning/phases/02-match-lifecycle-breach-outcomes/02-02-SUMMARY.md
@apps/server/src/server.ts
@apps/server/AGENTS.md
@tests/integration/server/server.test.ts
@tests/integration/server/match-lifecycle.test.ts
@.planning/phases/03-deterministic-build-queue-validation/03-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>task 1: add RED integration specs for queue ack/outcome contract and bypass rejection</name>
  <files>tests/integration/server/server.test.ts, tests/integration/server/match-lifecycle.test.ts</files>
  <action>Create failing integration assertions that lock: (a) `build:queue` returns immediate `build:queued { eventId, executeTick }`, (b) each acknowledged `eventId` later receives exactly one terminal `build:outcome` with explicit `applied` or `rejected(reason)` and resolution tick fields, (c) out-of-bounds/outside-territory requests are rejected with explicit reason strings, and (d) direct `cell:update` mutation attempts in active play are rejected with a queue-only reason (no grid mutation side effect). Update lifecycle breach helpers to use queue-driven behavior rather than legacy direct cell mutation assumptions.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/server.test.ts tests/integration/server/match-lifecycle.test.ts</automated>
    <manual>Confirm RED assertions fail against pre-change runtime behavior before task 2.</manual>
  </verify>
  <done>Integration contract explicitly captures BUILD-01/02/03/04 behaviors at socket level.</done>
</task>

<task type="auto">
  <name>task 2: implement queue-only runtime mutation gate and terminal outcome emission</name>
  <files>apps/server/src/server.ts</files>
  <action>Use `queueBuildEvent()` as the only accepted gameplay mutation path. Keep `build:queue` acknowledgement semantics (`build:queued` to requester) and add room-scoped `build:outcome` emission from deterministic tick results and terminal pending-event drains. Map immediate validation failures to explicit rejection reasons (not generic `build-rejected`). Replace `cell:update` gameplay mutation behavior with explicit server rejection (queue-only contract) so no direct bypass mutation path remains. Ensure finished lifecycle transitions drain unresolved queued events with explicit terminal rejection reasons.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/server.test.ts tests/integration/server/match-lifecycle.test.ts</automated>
  </verify>
  <done>Server enforces queue-only gameplay mutations and emits complete deterministic build acknowledgement/outcome contract.</done>
</task>

<task type="auto">
  <name>task 3: align server contract documentation and run full phase regression set</name>
  <files>apps/server/AGENTS.md</files>
  <action>Update server runtime AGENTS contract to document `build:outcome` payload usage, canonical rejection reason expectations, and queue-only gameplay mutation policy. Keep docs aligned with emitted event names and avoid adding deferred Phase-4 queue timeline/economy guidance.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/server.test.ts tests/integration/server/match-lifecycle.test.ts tests/integration/server/lobby-contract.test.ts tests/integration/server/lobby-reconnect.test.ts</automated>
  </verify>
  <done>Runtime documentation and integration regressions align with deterministic build-queue validation contract.</done>
</task>

</tasks>

<verification>
Run the task 3 command and confirm integration suites pass with queue ack/outcome closure and queue-only mutation enforcement.
</verification>

<success_criteria>

- `build:queue` requests emit deterministic queued acknowledgement including execute tick.
- Every acknowledged build event emits one terminal `build:outcome` with explicit status/reason.
- Direct `cell:update` gameplay mutation attempts are rejected and do not mutate authoritative state.
- Explicit validation reasons are observable for bounds and territory failures.
  </success_criteria>

<output>
After completion, create `.planning/phases/03-deterministic-build-queue-validation/03-02-SUMMARY.md`
</output>
