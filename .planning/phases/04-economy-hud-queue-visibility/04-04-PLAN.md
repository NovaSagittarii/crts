---
phase: 04-economy-hud-queue-visibility
plan: '04'
type: execute
wave: 4
depends_on:
  - 04-03
files_modified:
  - apps/server/src/server.ts
  - package.json
  - apps/web/src/client.ts
  - tests/integration/server/bootstrap-smoke.test.ts
autonomous: true
gap_closure: true
requirements:
  - ECON-01
  - ECON-02
  - ECON-03
  - UX-01
must_haves:
  truths:
    - Browser users can load executable client assets from the server and reach `room:joined` plus `room:membership` before interacting with Phase 4 HUD/queue UX.
    - Connection/bootstrap failures are visible in status/lifecycle UI instead of leaving the interface stuck at the initial waiting text.
    - Economy HUD and pending-queue interactions remain reachable in normal startup because room membership bootstrap succeeds.
  artifacts:
    - path: apps/server/src/server.ts
      provides: Static-asset serving guardrails that prevent raw TypeScript fallback for browser bootstrap.
    - path: package.json
      provides: Start/build command path that guarantees executable client assets are generated before server launch.
    - path: apps/web/src/client.ts
      provides: Explicit socket connect/bootstrap error messaging on existing lifecycle and status surfaces.
    - path: tests/integration/server/bootstrap-smoke.test.ts
      provides: Automated smoke coverage for served HTML module executability and room membership handshake.
  key_links:
    - from: package.json
      to: apps/server/src/server.ts
      via: Start flow builds client bundle before static middleware serves browser entry assets.
      pattern: start|build|build:server|dist/client
    - from: apps/server/src/server.ts
      to: tests/integration/server/bootstrap-smoke.test.ts
      via: Smoke test validates HTML module entry resolves to executable JavaScript and reaches room bootstrap events.
      pattern: express.static|module|content-type|room:joined|room:membership
    - from: apps/web/src/client.ts
      to: apps/web/index.html
      via: Connect/bootstrap errors update existing status and lifecycle DOM fields for visible failure feedback.
      pattern: connect_error|status|lifecycle-status-line|setMessage
---

<objective>
Close the Phase 4 verification gap by hardening browser bootstrap so users can reliably reach room membership and the economy HUD/queue flow.

Purpose: Remove the static-serving failure mode that can deliver non-executable client entrypoints and surface bootstrap failures clearly when they occur.
Output: Server/bootstrap guardrails, explicit client error messaging, and an automated smoke test that proves HTML->module->membership flow.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-economy-hud-queue-visibility/04-CONTEXT.md
@.planning/phases/04-economy-hud-queue-visibility/04-VERIFICATION.md
@.planning/phases/04-economy-hud-queue-visibility/04-03-SUMMARY.md
@apps/server/src/server.ts
@apps/web/src/client.ts
@package.json
@tests/integration/server/server.test.ts
</context>

<tasks>

<task type="auto">
  <name>task 1: harden server static bootstrap path to require executable client assets</name>
  <files>apps/server/src/server.ts, package.json</files>
  <action>Implement a server bootstrap policy that prevents the raw `apps/web` TypeScript fallback from being used in standard server mode. Require executable client assets from `dist/client` (or fail fast with an actionable startup error) so browser entry never resolves to `./src/client.ts` static source. Keep this compatible with existing integration harness behavior by using an explicit runtime mode/guard when needed. Update npm start flow so client and server builds run before launching the dist server entrypoint.</action>
  <verify>
    <automated>npm run build && npm run build:server</automated>
    <manual>Confirm startup path either serves built assets or exits with a clear remediation message; no silent source fallback remains.</manual>
  </verify>
  <done>Server startup guarantees executable client assets for browser entry and no longer allows the verified `video/mp2t` TypeScript bootstrap failure mode.</done>
</task>

<task type="auto">
  <name>task 2: add explicit client connect/bootstrap failure messaging</name>
  <files>apps/web/src/client.ts</files>
  <action>Add socket-level bootstrap failure handling (`connect_error`, reconnect failure surfaces) that updates `#status`, `#lifecycle-status-line`, and existing inline/toast messaging with clear recovery guidance. Preserve current Phase 4 locked HUD/queue behaviors; this task only adds visibility for failure states so users do not remain on ambiguous waiting text when membership bootstrap fails.</action>
  <verify>
    <automated>npm run build</automated>
  </verify>
  <done>Connection/bootstrap failures are user-visible in the existing lifecycle/status UI and no longer appear as silent hangs.</done>
</task>

<task type="auto">
  <name>task 3: add automated HTML->module->membership smoke coverage</name>
  <files>tests/integration/server/bootstrap-smoke.test.ts</files>
  <action>Create a focused integration smoke test that starts the server on an ephemeral port, fetches served HTML, resolves and requests the declared module entry, asserts executable JavaScript content (not raw TypeScript MIME), then opens a real Socket.IO client to verify `room:joined` and `room:membership` arrive within bounded waits. Follow existing integration teardown patterns (close sockets, stop server) and keep assertions contract-level.</action>
  <verify>
    <automated>npm run build && npm run build:server && npx vitest run tests/integration/server/bootstrap-smoke.test.ts</automated>
  </verify>
  <done>Automated smoke check reproduces the verified failure surface and passes only when served browser assets bootstrap to membership successfully.</done>
</task>

</tasks>

<verification>
Run `npm run build && npm run build:server && npx vitest run tests/integration/server/bootstrap-smoke.test.ts tests/integration/server/server.test.ts tests/web/economy-view-model.test.ts` and confirm bootstrap smoke plus economy/queue regressions pass together.
</verification>

<success_criteria>

- Standard server startup no longer serves raw TypeScript browser entry assets.
- Browser bootstrap failures are explicit in status/lifecycle messaging.
- Automated smoke test proves served HTML module executes and reaches `room:joined` + `room:membership`.
- ECON-01, ECON-02, ECON-03, and UX-01 are unblocked in practice because users can enter room flow and access Phase 4 UI.
  </success_criteria>

<output>
After completion, create `.planning/phases/04-economy-hud-queue-visibility/04-04-SUMMARY.md`
</output>
