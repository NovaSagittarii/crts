---
phase: 04-economy-hud-queue-visibility
plan: '02'
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - apps/server/src/server.ts
  - apps/server/AGENTS.md
  - tests/integration/server/server.test.ts
autonomous: true
requirements:
  - ECON-02
  - ECON-03
  - UX-01
must_haves:
  truths:
    - Runtime exposes authoritative affordability preview responses before queue submission.
    - Unaffordable queue attempts return explicit rejection reasons with exact resource deficit numbers at socket boundary.
    - Room-scoped `state` and `build:outcome` events preserve pending-queue and affordability metadata from engine payloads.
  artifacts:
    - path: apps/server/src/server.ts
      provides: Socket handlers for build preview, structured queue rejection mapping, and room-scoped emission of enriched state/outcome payloads.
    - path: tests/integration/server/server.test.ts
      provides: Integration coverage for preview contract, insufficient-resource deficit feedback, and pending queue state projection behavior.
    - path: apps/server/AGENTS.md
      provides: Updated server event contract documentation for preview and deficit metadata surfaces.
  key_links:
    - from: apps/server/src/server.ts
      to: packages/rts-engine/rts.ts
      via: Server preview and queue handlers use engine authority outputs directly (no ad-hoc cost math in runtime layer).
      pattern: build:preview|queueBuildEvent|reason|deficit
    - from: apps/server/src/server.ts
      to: tests/integration/server/server.test.ts
      via: Integration assertions verify runtime emits deterministic preview/rejection/pending payload contracts.
      pattern: room:error|build:preview|build:queue|state
---

<objective>
Wire the Socket.IO runtime so affordability preview/rejection feedback and pending queue projection are observable and testable end-to-end.

Purpose: Deliver ECON-02/ECON-03/UX-01 contracts at runtime boundary on top of engine authority from 04-01.
Output: Updated server handlers, integration coverage, and server contract docs aligned to new economy/queue metadata.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-economy-hud-queue-visibility/04-CONTEXT.md
@.planning/phases/04-economy-hud-queue-visibility/04-RESEARCH.md
@.planning/phases/04-economy-hud-queue-visibility/04-01-SUMMARY.md
@apps/server/src/server.ts
@tests/integration/server/server.test.ts
@apps/server/AGENTS.md
</context>

<tasks>

<task type="auto">
  <name>task 1: add RED integration coverage for preview contract, deficit rejections, and pending queue state projection</name>
  <files>tests/integration/server/server.test.ts</files>
  <action>Add failing integration tests for Phase-4 runtime behavior: (a) a build preview request returns affordability response fields (`affordable`, `needed`, `current`, `deficit`) for selected template/coordinates, (b) unaffordable queue requests are rejected without `build:queued` and include exact deficit numbers in socket-visible payloads, and (c) `state` payloads expose pending queue rows that remain sorted by `executeTick` then `eventId` while events are pending and disappear after terminal outcome resolution. Keep assertions external-contract focused and deterministic.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/server.test.ts</automated>
    <manual>Confirm newly added assertions fail before task 2 and pass after runtime wiring is implemented.</manual>
  </verify>
  <done>Integration suite explicitly locks preview, deficit rejection, and pending queue projection runtime contracts.</done>
</task>

<task type="auto">
  <name>task 2: implement server preview handler and structured affordability rejection mapping</name>
  <files>apps/server/src/server.ts</files>
  <action>Implement runtime handling for build preview requests using engine authority helpers from 04-01 (do not hand-roll cost logic in server). Update `build:queue` handling to emit structured reason/deficit metadata for insufficient resources and preserve canonical reason codes for other validation failures. Ensure room-scoped `state` and `build:outcome` emissions pass through enriched pending queue and affordability fields without lossy remapping. Preserve queue-only mutation gate (`cell:update` rejection) and existing lifecycle constraints.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/server.test.ts</automated>
  </verify>
  <done>Runtime exposes authoritative preview and rejection payloads with deterministic pending queue visibility for clients.</done>
</task>

<task type="auto">
  <name>task 3: align server AGENTS contract docs and rerun lifecycle integration guardrails</name>
  <files>apps/server/AGENTS.md</files>
  <action>Update server runtime contract documentation to include build preview request/response events, `room:error` deficit metadata, and enriched queue/outcome/state field expectations. Keep docs aligned with actual emitted event names and payload shapes from task 2; avoid introducing non-phase features.</action>
  <verify>
    <automated>npx vitest run tests/integration/server/server.test.ts tests/integration/server/match-lifecycle.test.ts</automated>
  </verify>
  <done>Server contract docs and integration suites align with authoritative Phase-4 runtime economy/queue signaling.</done>
</task>

</tasks>

<verification>
Run the task 3 command and confirm integration suites pass with preview, deficit rejection, and pending queue projection contracts in place.
</verification>

<success_criteria>

- Clients can request affordability preview and receive exact deficit numbers before queue submission.
- Unaffordable queue attempts are rejected with explicit reason and `needed/current/deficit` feedback.
- State/outcome runtime payloads preserve pending-queue and affordability metadata required by UI timeline/HUD layers.
  </success_criteria>

<output>
After completion, create `.planning/phases/04-economy-hud-queue-visibility/04-02-SUMMARY.md`
</output>
