---
phase: 04-economy-hud-queue-visibility
plan: '03'
type: execute
wave: 3
depends_on:
  - 04-01
  - 04-02
files_modified:
  - apps/web/index.html
  - apps/web/src/client.ts
  - apps/web/src/economy-view-model.ts
  - tests/web/economy-view-model.test.ts
  - apps/web/AGENTS.md
autonomous: true
requirements:
  - ECON-01
  - ECON-02
  - ECON-03
  - UX-01
must_haves:
  truths:
    - Players always see current resources and net income per tick near build controls during active play.
    - Queue action stays disabled when selected build placement is unaffordable and inline feedback shows exact `needed` vs `current` deficits.
    - Income/resource changes trigger subtle tick pulse cues and a single aggregated delta chip per tick with short cause labels.
    - Pending build timeline shows pending-only items grouped by execute tick with template, execute-tick context, and relative ETA labels.
  artifacts:
    - path: apps/web/index.html
      provides: HUD/readout, affordability inline feedback region, queue action control, and pending timeline containers near build controls.
    - path: apps/web/src/economy-view-model.ts
      provides: Pure helpers for pending timeline grouping, relative ETA labels, and per-tick delta aggregation.
    - path: tests/web/economy-view-model.test.ts
      provides: Automated coverage for timeline grouping order and delta aggregation/cause-label rules.
    - path: apps/web/src/client.ts
      provides: Runtime wiring from authoritative state/preview/rejection/outcome payloads to HUD, affordability gating, and timeline rendering.
    - path: apps/web/AGENTS.md
      provides: Updated client event-usage contract including preview and enriched economy/queue payload handling.
  key_links:
    - from: apps/web/src/client.ts
      to: apps/web/src/economy-view-model.ts
      via: Client rendering delegates grouping/relative-eta/delta aggregation to deterministic helper functions.
      pattern: groupPendingByExecuteTick|formatRelativeEta|aggregateIncomeDelta
    - from: apps/web/src/client.ts
      to: apps/web/index.html
      via: HUD and timeline elements are populated from authoritative `state` plus preview/rejection payloads.
      pattern: resources|income|queue|pending|deficit
    - from: apps/web/src/client.ts
      to: tests/web/economy-view-model.test.ts
      via: Test suite locks ordering, ETA text shape, and per-tick aggregation rules used by UI.
      pattern: executeTick|eventId|due now|cause
---

<objective>
Implement the in-match economy HUD and pending queue visibility UX using only authoritative server payloads.

Purpose: Deliver ECON-01/ECON-02/ECON-03/UX-01 and all locked Phase-4 UI decisions with clear affordability and timeline feedback.
Output: Updated web markup/client logic, deterministic view-model helpers + tests, and client contract docs.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-economy-hud-queue-visibility/04-CONTEXT.md
@.planning/phases/04-economy-hud-queue-visibility/04-RESEARCH.md
@.planning/phases/04-economy-hud-queue-visibility/04-01-SUMMARY.md
@.planning/phases/04-economy-hud-queue-visibility/04-02-SUMMARY.md
@apps/web/index.html
@apps/web/src/client.ts
@apps/web/AGENTS.md
</context>

<tasks>

<task type="auto">
  <name>task 1: add deterministic web view-model helpers and RED tests for timeline + delta aggregation</name>
  <files>apps/web/src/economy-view-model.ts, tests/web/economy-view-model.test.ts</files>
  <action>Create pure helper functions for (a) grouping pending queue rows by `executeTick` with deterministic secondary ordering by `eventId`, (b) formatting relative ETA labels (`due now`, `in N ticks`) without absolute-only labels, and (c) aggregating one income delta cue per tick with short cause labels and negative-net color-state flags. Add failing-first tests that lock these behaviors so UI rendering remains deterministic and low-noise.</action>
  <verify>
    <automated>npx vitest run tests/web/economy-view-model.test.ts</automated>
    <manual>Confirm helper tests fail before implementation and pass after helper logic is added.</manual>
  </verify>
  <done>Web helper layer has deterministic, tested grouping/ETA/delta logic ready for client integration.</done>
</task>

<task type="auto">
  <name>task 2: implement HUD affordability gating, inline deficit feedback, and pending timeline rendering</name>
  <files>apps/web/index.html, apps/web/src/client.ts</files>
  <action>Update build/HUD UI to satisfy locked decisions exactly: show resources + net income per tick near build controls; add subtle pulse cues on resource/income changes; show a per-tick delta chip with short cause label; use color-only negative-net indication; provide deeper income breakdown via hover/expand detail. Replace template-only queue interaction with explicit queue action control that is disabled when preview says unaffordable, and render inline reason text near that action including exact `needed` vs `current` values. Render pending queue timeline from authoritative pending payloads, grouped by execute tick, pending-only, with each item showing template, execute-tick context, and relative ETA labels (no absolute-only timing labels).</action>
  <verify>
    <automated>npm run build</automated>
  </verify>
  <done>Client UI displays authoritative economy/timeline signals and enforces disabled queue action with inline deficit feedback for unaffordable selections.</done>
</task>

<task type="auto">
  <name>task 3: align web AGENTS contract docs and run combined web + integration verification</name>
  <files>apps/web/AGENTS.md</files>
  <action>Update web client AGENTS event-usage guidance to include build-preview consumption and enriched economy/queue payload handling (`state` pending queue + income breakdown, `room:error` deficit metadata, `build:outcome` reconciliation). Keep docs constrained to Phase-4 scope and server-authoritative rendering model.</action>
  <verify>
    <automated>npm run build && npx vitest run tests/web/economy-view-model.test.ts tests/integration/server/server.test.ts</automated>
  </verify>
  <done>Client event-contract docs and automated checks confirm the economy HUD and queue-visibility UX is wired to authoritative runtime payloads.</done>
</task>

</tasks>

<verification>
Run the task 3 command and confirm build + web helper tests + integration server tests pass with locked HUD and queue-visibility behavior implemented.
</verification>

<success_criteria>

- HUD always shows current resources and net-per-tick income near build controls.
- Queue action is disabled for unaffordable selections with inline exact deficit copy (`needed` vs `current`).
- Income changes emit one subtle aggregated cue per tick with cause labels and color-only negative-net signaling.
- Pending queue timeline is grouped by execute tick and uses relative ETA labels for pending items only.
  </success_criteria>

<output>
After completion, create `.planning/phases/04-economy-hud-queue-visibility/04-03-SUMMARY.md`
</output>
