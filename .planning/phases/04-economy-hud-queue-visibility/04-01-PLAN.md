---
phase: 04-economy-hud-queue-visibility
plan: '01'
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/rts-engine/rts.ts
  - packages/rts-engine/rts.test.ts
  - packages/rts-engine/socket-contract.ts
autonomous: true
requirements:
  - ECON-02
  - ECON-03
  - UX-01
must_haves:
  truths:
    - Queue affordability is computed in engine authority with explicit `needed`, `current`, and `deficit` numbers for insufficient-resource outcomes.
    - Authoritative room state includes deterministic pending queue rows (`executeTick`, `eventId`, template metadata) so reconnecting clients can rebuild pending timeline state.
    - Authoritative room state includes per-team income breakdown data that explains net income changes tick-to-tick.
  artifacts:
    - path: packages/rts-engine/rts.ts
      provides: Deterministic affordability precheck/preview helpers, pending queue projection, and income-breakdown fields on room payloads.
    - path: packages/rts-engine/socket-contract.ts
      provides: Shared socket DTO typings for affordability metadata, pending queue rows, and preview event payloads.
    - path: packages/rts-engine/rts.test.ts
      provides: Unit regression coverage for affordability deficits, pending queue ordering, and dynamic income-breakdown behavior.
  key_links:
    - from: packages/rts-engine/rts.ts
      to: packages/rts-engine/socket-contract.ts
      via: New affordability and pending-queue DTO fields stay type-aligned across engine and runtime transport boundaries.
      pattern: insufficient-resources|deficit|pendingBuild|incomeBreakdown|build:preview
    - from: packages/rts-engine/rts.ts
      to: packages/rts-engine/rts.test.ts
      via: Unit tests lock deterministic ordering (`executeTick` then `eventId`) and exact affordability deficit math.
      pattern: queueBuildEvent|createRoomStatePayload|pendingBuildEvents|needed|deficit
---

<objective>
Add deterministic engine and shared-contract primitives for affordability, income explainability, and pending-queue projection.

Purpose: Establish authoritative data required by ECON-02, ECON-03, and UX-01 before runtime/UI wiring.
Output: Updated engine payloads, affordability metadata surfaces, preview contract types, and unit regression coverage.
</objective>

<execution_context>
@./.opencode/get-shit-done/workflows/execute-plan.md
@./.opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-economy-hud-queue-visibility/04-CONTEXT.md
@.planning/phases/04-economy-hud-queue-visibility/04-RESEARCH.md
@.planning/phases/03-deterministic-build-queue-validation/03-02-SUMMARY.md
@packages/rts-engine/rts.ts
@packages/rts-engine/rts.test.ts
@packages/rts-engine/socket-contract.ts
</context>

<tasks>

<task type="auto">
  <name>task 1: add RED unit coverage for affordability deficits, queue projection, and income breakdown payloads</name>
  <files>packages/rts-engine/rts.test.ts</files>
  <action>Add failing-first unit tests that lock three Phase-4 contracts: (a) queue-time affordability checks reject unaffordable requests with exact `needed/current/deficit` metadata, (b) room payload projection includes pending queue entries sorted by `executeTick` then `eventId` with template identifiers/names needed for UI grouping, and (c) room payload projection includes per-team income-breakdown fields that change as active structures change. Keep assertions package-local; do not add server/socket expectations in this task.</action>
  <verify>
    <automated>npx vitest run packages/rts-engine/rts.test.ts</automated>
    <manual>Confirm these new assertions fail before task 2 implementation and pass afterward.</manual>
  </verify>
  <done>Unit suite captures deterministic affordability, pending queue, and income-breakdown guarantees required by ECON-02/ECON-03/UX-01.</done>
</task>

<task type="auto">
  <name>task 2: implement engine affordability metadata and state payload projection</name>
  <files>packages/rts-engine/rts.ts</files>
  <action>Implement a shared affordability evaluator used for both queue-time acceptance and execution-time revalidation, with structured deficit metadata (`needed`, `current`, `deficit`) for `insufficient-resources`. Reject unaffordable queue requests before enqueue while preserving deterministic queue behavior for accepted events. Extend room/team payload projection to include pending queue rows (sorted by `executeTick` then `eventId`) and income-breakdown fields that explain net-per-tick composition. Keep queue-only mutation authority intact and do not introduce client-authored simulation logic.</action>
  <verify>
    <automated>npx vitest run packages/rts-engine/rts.test.ts</automated>
  </verify>
  <done>Engine emits authoritative affordability metadata plus pending queue and income-breakdown payload fields with deterministic ordering.</done>
</task>

<task type="auto">
  <name>task 3: publish shared socket contract types for preview, deficits, and pending queue fields</name>
  <files>packages/rts-engine/socket-contract.ts</files>
  <action>Update shared Socket.IO contract typings to include the new affordability metadata fields, pending queue projection fields, income-breakdown payload fields, and build-preview request/response event payloads. Keep existing event names (`build:queue`, `build:queued`, `build:outcome`, `state`) stable so runtime layers extend behavior without breaking previous contracts.</action>
  <verify>
    <automated>npm run build:server && npx vitest run packages/rts-engine/rts.test.ts</automated>
  </verify>
  <done>Runtime layers can consume authoritative preview/affordability/pending-queue/income fields through one typed shared contract.</done>
</task>

</tasks>

<verification>
Run the task 3 command and confirm package build plus rts-engine unit suite pass with the new affordability/pending/income contract fields.
</verification>

<success_criteria>

- Unaffordable queue requests are rejected with exact `needed/current/deficit` metadata from engine authority.
- Room payloads include deterministic pending queue rows needed for execute-tick timeline grouping.
- Room payloads include income-breakdown fields needed for net-income explainability in HUD.
  </success_criteria>

<output>
After completion, create `.planning/phases/04-economy-hud-queue-visibility/04-01-SUMMARY.md`
</output>
